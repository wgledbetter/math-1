<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Stan Math Library: OpenCL Developer Guide</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="$standoxy.css" rel="stylesheet" type="text/css">
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="stanlogo-main.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname"><a href="https://mc-stan.org/math">Stan Math Library</a>
   &#160;<span id="projectnumber">4.0.1</span>
   </div>
   <div id="projectbrief">Automatic Differentiation</div>
  </td>
   <td>        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
</td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('opencl_guide.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">OpenCL Developer Guide </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The OpenCL integration with Stan is meant to be seamless and user friendly - setting a flag moves the computation of supported routines to the GPU, with no need to change Stan code. The API provides experts with a simple way of implementing their GPU kernels or to use existing GPU kernels as building blocks. In the below we detail the main pieces of the architecture and how to add your own OpenCL routines.</p>
<p>Stan's OpenCL backend uses a single context to receive data and routines from individual nodes in the expression tree. Ensuring there is only one context and queue per device for the life of the program makes context management simpler. The implementation of the OpenCL context which manages the device queue follows the Meyers singleton pattern and sits in the class <code>opencl_context_base</code>.</p>
<p>Instead of calling <code>opencl_context_base::getInstance().method()</code>, developers can access the context through a friend adapter class <code>opencl_context</code> which provides an API for accessing the base context. If the OpenCL implementation supports asynchronous operations, then the context asynchronously executes kernels. Asynchronous operations are particularly useful in conjunction with threading as the individual threads will be able to enqueue operations, which will execute while threads do other calculations using CPU.</p>
<h2>Matrices On The GPU</h2>
<p>The base matrix class <code>matrix_cl</code> holds the device memory buffer, meta-information on the matrix, and methods for reading and writing event stacks for asynchronous computation. When a kernel receives a <code>matrix_cl</code>, the kernel's event is attached to the appropriate read or write event stack. Reading and writing to OpenCL buffers uses the generic <code>enqueueWriteBuffer</code> and <code>enqueueWriteBuffer</code> methods. Because Stan Math heavily relies on <a class="el" href="d0/da5/namespace_eigen.html" title="(Expert) Numerical traits for algorithmic differentiation variables. ">Eigen</a> matrices, constructors and methods are available for passing data back and forth.</p>
<p>Developers can pass in <a class="el" href="d0/da5/namespace_eigen.html" title="(Expert) Numerical traits for algorithmic differentiation variables. ">Eigen</a> matrices directly to the <code>matrix_cl</code> constructor or use the <code><a class="el" href="d5/de5/group__opencl.html#ga8bbce98664097d5ea8e55b0b931bd721" title="Copies the source Eigen matrix, std::vector or scalar to the destination matrix that is stored on the...">to_matrix_cl()</a></code> or <code><a class="el" href="d5/de5/group__opencl.html#gadf2a61125c6dca5e5a400d56e24cc6d5" title="Copies the source matrix that is stored on the OpenCL device to the destination Eigen matrix...">from_matrix_cl()</a></code> methods.</p>
<div class="fragment"><div class="line">Eigen::MatrixXd m(2, 2);</div><div class="line">m &lt;&lt; 1, 2, 3, 4;</div><div class="line"></div><div class="line">matrix_cl&lt;double&gt; A(m);</div><div class="line">matrix_cl&lt;double&gt; B(2, 2);</div><div class="line"></div><div class="line">B = <a class="code" href="d5/de5/group__opencl.html#ga8bbce98664097d5ea8e55b0b931bd721">to_matrix_cl</a>(m);</div><div class="line">Eigen::MatrixXd C = <a class="code" href="d5/de5/group__opencl.html#gadf2a61125c6dca5e5a400d56e24cc6d5">from_matrix_cl</a>(B);</div></div><!-- fragment --><p>Similar constructors for the <code>matrix_cl</code> class are available for standard vectors <code>std::vector&lt;T&gt;</code> and arrays of doubles.</p>
<p>We can reduce the data transfers of triangular matrices by only transferring the non-zero parts of the matrix in a packed form. The kernel <code>unpack</code> deals with unpacking the packed form shown on the right-hand side on to a flat matrix shown on the left-hand side. For lower (upper) triangular matrices, the upper (lower) triangular fill with zeros. The kernel <code>pack</code> packs the flat matrix to packed form for the transfer back to the host's global memory.</p>
<div class="fragment"><div class="line">matrix_cl&lt;double&gt; L = <a class="code" href="d5/de5/group__opencl.html#ga490df7651c22c9e06d09da69ad303e30">packed_copy</a>(L_val_cpu, M_, matrix_view::Lower);</div></div><!-- fragment --><h2>Adding New OpenCL Kernels</h2>
<p>The OpenCL specification demands that strings are used to represent OpenCL kernels. However, having a large number of files comprised of strings is unwieldy and difficult to maintain. Stan wraps its kernels inside of a STRINGIFY macro, which gives developers access to the standard set of developer tools such as code highlighting, linting, Doxygen, and auto-formatting. This style makes the kernel code easier to maintain compared to having files full of strings.</p>
<div class="fragment"><div class="line"><span class="keyword">const</span> <span class="keywordtype">char</span> *example_kernel_code = <a class="code" href="d6/d9f/stringify_8hpp.html#a74c9963ef1fdcd835d58b542e27b8417">STRINGIFY</a>(</div><div class="line"></div><div class="line">  __kernel <span class="keywordtype">void</span> example(<span class="keywordtype">double</span> *A, <span class="keywordtype">double</span> *B, <span class="keywordtype">int</span> *val) {</div><div class="line">          <span class="comment">// kernel code...</span></div><div class="line">  }</div><div class="line"></div><div class="line">);</div><div class="line"></div><div class="line"><span class="keyword">const</span> kernel_cl&lt;out_buffer, in_buffer, int&gt; example(</div><div class="line">  <span class="stringliteral">&quot;example&quot;</span>, example_kernel_code, {<span class="stringliteral">&quot;THREAD_BLOCK_SIZE&quot;</span>, 32);</div></div><!-- fragment --><p>In the above, a developer uses <code>STRINGIFY</code> to create a <code>const char*</code> that holds the kernel code. That string passes into the <code>kernel_cl</code> struct templated by the kernel argument types and with arguments giving the name of the kernel, the kernel code, and optional kernel macros they would like to have defined in the kernel.</p>
<p>Internally, we keep track of OpenCL events via queues on each <code>matrix_cl</code> object that we use to conservatively prevent race conditions and provide ordering where necessary. <code>out_buffer</code> and <code>in_buffer</code> are empty structs that we pass as template arguments to configure the kernel during construction to indicate the directionality of each input buffer. At runtime, the kernel will check the correct event queues on its arguments for events it needs to wait for and then attach the event representing the kernel's completion to each buffer's queues correctly. That way we ensure that an operation that, for example, writes to a buffer, is completed before we allow the OpenCL runtime to read from that buffer.</p>
<p>When the <code>kernel_cl</code> struct is constructed, it compiles the kernel and developers call the kernel with</p>
<div class="fragment"><div class="line">matrix_cl&lt;double&gt; foo = <span class="comment">//...</span></div><div class="line">matrix_cl&lt;double&gt; goo;</div><div class="line">example(cl::NDRange(...), goo, foo, 10);</div></div><!-- fragment --><p>Depending on the<code>in/out_buffer</code> passed when constructing the kernel, events will be added to the appropriate <code>matrix_cl</code> read and/or write event stack. For instance, in the above, <code>goo</code> in the output and will have the kernel's event attached to it's <code>write_stack</code>. While <code>foo</code> will have the kernel's event attached to it's <code>read_stack</code>. Later kernel calls that write to <code>foo</code> will know to wait for all the event's in <code>foo</code>'s <code>read_stack</code> and <code>write_stack</code> while kernels that use <code>goo</code> as input will know to wait for the event's in <code>goo</code>'s <code>write_stack</code>. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->

<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">
    <div class="contents" style="font-size:100%;">
      <span style="float:left; margin=0 1em 0 1em;">
      &nbsp;&nbsp;&nbsp;&nbsp;
      [ <a href="http://mc-stan.org/">Stan Home Page</a> ]
      </span>
      <span style="float:right; margin=0 1em 0 1em;">
      <i>&copy; 2011&ndash;2019,
      Stan Development Team.
      &nbsp;&nbsp;&nbsp;&nbsp;
      </i>
      </span>
    </div> </li>
  </ul>
</div>
</body>
</html>
